<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Documentation Source: compiler-js.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">Documentation</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-compile-html.html">compile-html</a>
						</li>
						
						<li>
							<a href="module-compiler-css.html">compiler-css</a>
						</li>
						
						<li>
							<a href="module-compiler-js.html">compiler-js</a>
						</li>
						
						<li>
							<a href="module-node.html">node</a>
						</li>
						
						<li>
							<a href="module-project.html">project</a>
						</li>
						
						<li>
							<a href="module-source.html">source</a>
						</li>
						
						<li>
							<a href="module-template.html">template</a>
						</li>
						
						<li>
							<a href="module-tfw.html">tfw</a>
						</li>
						
						<li>
							<a href="module-util.html">util</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-project-Project.html">project~Project</a>
						</li>
						
						<li>
							<a href="module-source-Source.html">source~Source</a>
						</li>
						
						<li>
							<a href="module-util-Dependencies.html">util~Dependencies</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: compiler-js.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">/**
 * @module compiler-js
 */

var Util = require("./util");
var UglifyJS = require("uglify-js");
var Path = require("path");

exports.compile = function(source) {
    if (source.isUptodate()) return false;
    console.log("Compiling " + source.name().yellow);
    var content = source.read();
    var visitor = Visitor(content);
    var walker = new UglifyJS.TreeWalker(visitor.walk);
    var tree;
    try {
        tree = UglifyJS.parse(content, {filename: source.getAbsoluteFilePath()});
    }
    catch (ex) {
        source.prj().fatal(
            "Exception raised in parsing JS file \"" + source.name() + "\":\n" + ex,
            -1,
            "compiler-js"
        );
    }
    tree.walk(walker);
    var def = visitor.result();
    var needs = [];
    def.needs.forEach(
        function(item) {
            needs.push("cls/" + item + ".js");
        }
    );
    source.tag("needs", needs);
    source.tag("zip", Util.zipJS(content));
    var cssName = source.name().substr(0, source.name().length - 2) + "css";
    var cssPath = source.prj().srcOrLibPath(cssName);
    if (cssPath) {
        source.tag("css", cssName);
    } else {
        source.tag("css", null);
    }
    source.save();
    return true;
};






var Visitor = function(content) {
    /**
     * Throw a fatal exception with a portion of the buggy code.
     */
    function fatal(node, err) {
        var msg= '', line = node.start.line, col = node.start.col;
        msg += "----------------------------------------"
            + "----------------------------------------\n";
        msg += "  file: " + node.start.file + "\n";
        msg += "  line: " + line + "\n";
        msg += "  col.: " + col + "\n";
        msg += "----------------------------------------"
            + "----------------------------------------\n";
        var lines = content.split("\n"),
        lineIndex, indent = '',
        min = Math.max(0, line - 1 - 2),
        max = line;
        for (lineIndex = min ; lineIndex &lt; max ; lineIndex++) {
            msg += lines[lineIndex].trimRight() + "\n";
        }
        for (lineIndex = 0 ; lineIndex &lt; col ; lineIndex++) {
            indent += ' ';
        }
        msg += "\n" + indent + "^".bold + "\n";
        throw {fatal: err.bold + "\n" + msg};
    }

    /**
     * Extract comments before a node.
     */
    function comment(node) {
        var txt = '';
        var comments = node.start.comments_before;
        if (comments) {
            comments.forEach(
                function(comment) {
                    txt += comment.value;
                }
            );
        }
        return txt;
    }

    var cls = {needs:[], functions:{}};
    var currentMethod;
    var nodePath = '', nodePathStack = [];
    var envFatal = function(msg) {
        return function(node) {
            fatal(node, msg);
        };
    };
    var env;

    /**
     * Add a dependency in "cls.needs" if it is not yet in the array.
     * @return true if the class exists.
     */
    function need(name) {
        var i, item;
        for (i = 0 ; i &lt; cls.needs.length ; i++) {
            item = cls.needs[i];
            if (item == name) {
                return true;
            }
        }
        cls.needs.push(name);
        return true;
    }

    var env$$3 = function(node) {
        if (node.TYPE == 'String') {
            if (!need(node.value)) {
                fatal(node, "Class not found: \"" + node.value + "\"!");
            }
        } else {
            fatal(node, "Instanciation of TFW classes must be done with static strings!");
        }
        env = env$$1;
    };

    var env$$2 = function(node) {
        if (node.TYPE == 'SymbolRef' &amp;&amp; node.name == '$$') {
            env = env$$3;
        } else {
            env = env$$1;
        }
    };

    function env$$1(node) {
        if (node.TYPE == 'Call') {
            env = env$$2;
        }
    };


    var classProperty = "";
    var registry = {
        "Toplevel/": function(node) {
            cls.comment = comment(node);
        },
        "Toplevel/SimpleStatement/Assign/Sub/SymbolRef/": function(node) {
            if (node.name == 'window') {
                return {
                    "../String/": function(node) {
                        var className = node.value;
                        if (className.substr(0, 5) != 'TFW::') {
                            fatal(node, "Class name must begin with \"TFW::\"!");
                        }
                        className = className.substr(5);
                        cls.name = className;
                        return {
                            "Toplevel/SimpleStatement/Assign/Object/ObjectKeyVal/": function(node) {
                                switch (node.key) {
                                case 'superclass':
                                    env = function(node) {
                                        if (node.TYPE != "String") {
                                            fatal(node, "superclass must be a STRING!");
                                        }
                                        if (!need(node.value)) {
                                            fatal(node, "Class not found: \"" + node.value + "\"!");
                                        }
                                        cls.superclass = node.value;
                                    };
                                    break;
                                case 'singleton':
                                    env = function(node) {
                                        if (node.TYPE != "True") {
                                            fatal(
                                                node,
                                                "Property \"singleton\" is not mandatory. "
                                                    + "But if you use it, it must be equal to \"true\"!"
                                            );
                                        }
                                        cls.singleton = true;
                                        env = null;
                                    };
                                    break;
                                case 'init':
                                    cls.init = comment(node);
                                    return {
                                        "./Function/": function(node) {
                                            env = env$$1;
                                        },
                                        "./Function/SymbolFunarg/":
                                        envFatal(
                                            "Arguments are not allowed in constructor! "
                                                + "Use \"attributes\" instead."
                                        )
                                    };
                                case 'functions':
                                    return {
                                        "./Object/ObjectKeyVal/": function(node) {
                                            if (cls.functions[node.key]) {
                                                fatal(node, "Already defined function \"" + node.key + "\"!");
                                            }
                                            currentMethod = {
                                                comment: comment(node),
                                                args: []
                                            };
                                            cls.functions[node.key] = currentMethod;
                                            env = env$$1;
                                            return {
                                                "./Function/SymbolFunarg/": function(node) {
                                                    currentMethod.args.push(node.name);
                                                },
                                                "..": function(node) {
                                                    env = null;
                                                }
                                            };
                                        }
                                    };
                                case 'lang':
                                case 'attributes':
                                case 'signals':
                                    env = null;
                                    break;
                                case 'classInit':
                                    return {
                                        "./Function/": function(node) {
                                            env = env$$1;
                                        }
                                    };
                                    break;
                                default:
                                    fatal(node, "Unknown class property: \"" + node.key + "\"!");
                                }
                            }
                        }
                    }
                };
            }
            return false;
        }
    };

    return {
        walk: function(node, down) {
            nodePathStack.push(node.TYPE);
            nodePath += node.TYPE + "/";
            //console.log(nodePath + "\t" + (node.key || node.name || node.value));
            var f = registry[nodePath];
            if (f &amp;&amp; typeof f === 'function') {
                var result = f(node, down);
                if (typeof result === 'object') {
                    var newReg = {}, key, val;
                    for (key in result) {
                        val = result[key];
                        if (key.charAt(0) == '.') {
                            // Chemin relatif.
                            key = Path.normalize(Path.join(nodePath, key)).replace(/\\/g, '/');
                        }
                        registry[key] = val;
                    }
                    down();
                }
                else if (result !== false) {
                    down();
                }
            } else {
                if (!env) {
                    down();
                }
                else if (false !== env(node)) {
                    down();
                }
            }
            nodePath = nodePath.substr(0, nodePath.length - nodePathStack.pop().length - 1);
            return true;
        },

        result: function() {
            return cls;
        }
    };
};

</pre>
	</article>
</section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a>
		on 2014-10-11T22:29:13+02:00 using the <a
			href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<!--<script src="scripts/sunlight.js"></script>-->
	<script src="scripts/docstrap.lib.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>

	<script>
		$( function () {
			$( "[id*='$']" ).each( function () {
				var $this = $( this );

				$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
			} );

			$( "#toc" ).toc( {
				anchorName  : function ( i, heading, prefix ) {
					return $( heading ).attr( "id" ) || ( prefix + i );
				},
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : "100px"
			} );

			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );
			$( '.dropdown-toggle' ).dropdown();
//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

			$( ".tutorial-section pre, .readme-section pre" ).each( function () {
				var $this = $( this );

				var example = $this.find( "code" );
				exampleText = example.html();
				var lang = /{@lang (.*?)}/.exec( exampleText );
				if ( lang && lang[1] ) {
					exampleText = exampleText.replace( lang[0], "" );
					example.html( exampleText );
					lang = lang[1];
				} else {
					lang = "javascript";
				}

				if ( lang ) {

					$this
						.addClass( "sunlight-highlight-" + lang )
						.addClass( "linenums" )
						.html( example.html() );

				}
			} );

			Sunlight.highlightAll( {
				lineNumbers : true,
				showMenu : true,
				enableDoclinks : true
			} );
		} );
	 </script>



	<!--Navigation and Symbol Display-->
	
	<script>
		$( function () {
			$( '#main' ).localScroll( {
				offset : { top : 60 } //offset by the height of your header (give or take a few px, see what works for you)
			} );
			$( "dt.name" ).each( function () {
				var $this = $( this ).find("h4");
				var icon = $( "<i/>" ).addClass( "icon-plus-sign" ).addClass( "pull-right" ).addClass( "icon-white" );
				var dt = $(this);
				var children = dt.next( "dd" );

				dt.prepend( icon ).css( {cursor : "pointer"} );
				dt.addClass( "member-collapsed" ).addClass( "member" );


				children.hide();

				dt.children().on( "click", function () {
					children = dt.next( "dd" );
					console.debug(dt, children)
					children.slideToggle( "fast", function () {

						if ( children.is( ":visible" ) ) {
							icon.addClass( "icon-minus-sign" ).removeClass( "icon-plus-sign" ).removeClass( "icon-white" );
							dt.addClass( "member-open" ).animate( "member-collapsed" );
						} else {
							icon.addClass( "icon-plus-sign" ).removeClass( "icon-minus-sign" ).addClass( "icon-white" );
							dt.addClass( "member-collapsed" ).removeClass( "member-open" );
						}
					} );
				} );

			} );
		} );
	</script>
	


	<!--Google Analytics-->
	

</body>
</html>
