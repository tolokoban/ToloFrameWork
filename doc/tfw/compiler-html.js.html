<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Documentation Source: compiler-html.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">Documentation</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-compile-html.html">compile-html</a>
						</li>
						
						<li>
							<a href="module-compiler-css.html">compiler-css</a>
						</li>
						
						<li>
							<a href="module-compiler-js.html">compiler-js</a>
						</li>
						
						<li>
							<a href="module-node.html">node</a>
						</li>
						
						<li>
							<a href="module-project.html">project</a>
						</li>
						
						<li>
							<a href="module-source.html">source</a>
						</li>
						
						<li>
							<a href="module-template.html">template</a>
						</li>
						
						<li>
							<a href="module-tfw.html">tfw</a>
						</li>
						
						<li>
							<a href="module-util.html">util</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-project-Project.html">project~Project</a>
						</li>
						
						<li>
							<a href="module-source-Source.html">source~Source</a>
						</li>
						
						<li>
							<a href="module-util-Dependencies.html">util~Dependencies</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: compiler-html.js</h1>
    
<section>
	<article>
		<pre
			class="sunlight-highlight-javascript linenums">/**
 * @module compile-html
 */

var FS = require("fs");
var Path = require("path");
var Source = require("./source");
var Tree = require("./htmltree");
var Util = require("./util");
var CompilerJS = require("./compiler-js");
var CompilerCSS = require("./compiler-css");
var Template = require("./template");


/**
 * Compile an HTML file if it is not uptodate.
 * @param {Project} prj Project object.
 * @param {string} filename name of the HTML file without the full path.
 * @see project~Project
 */
module.exports.compile = function(prj, filename) {
    var source = new Source(prj, filename);

    if (!isHtmlFileUptodate(source)) {
        console.log("Compiling " + filename.yellow);
        var root = Tree.parse(source.read());
        source.tag("resources", []);
        source.tag("dependencies", []);
        lookForStaticJavascriptAndStyle(root, source);
        expandWidgets(root, source);
        initControllers(root, source);
        zipInnerScriptsAndStyles(root, source);
        cleanupTreeAndStoreItInTag(root, source);
        var resources = new Util.Resources(source.tag("resources"));
        source.tag("resources", resources.data());
    }
    compileDependantScripts(root, source);
    compileDependantStyles(root, source);
    source.tag("dependencies", Util.removeDoubles(source.tag("dependencies")));
    source.tag("innerMapCSS", null);
    source.save();

    return source;
};

/**
 * To be uptodate, an HTML page must be more recent that all its dependencies.
 */
function isHtmlFileUptodate(source) {
    var dependencies = source.tag("dependencies") || [];
    var i, dep, file, prj = source.prj(),
    stat,
    mtime = source.modificationTime();
    for (i = 0 ; i &lt; dependencies.length ; i++) {
        dep = dependencies[i];
        file = prj.srcOrLibPath(dep);
        if (file) {
            stat = FS.statSync(file);
            if (stat.mtime > mtime) return false;
        }
    }
    return source.isUptodate();
}

/**
 * Remove all `extra` properties in the tree and store it in tag __`tree`__.
 */
function cleanupTreeAndStoreItInTag(root, source) {
    Tree.walk(
        root,
        function(node) {
            delete node.extra;
            if (node.children &amp;&amp; node.children.length == 0) {
                delete node.children;
            }
            if (node.attribs) {
                var count = 0, key;
                for (key in node.attribs) {
                    count++;
                }
                if (count == 0) {
                    delete node.attribs;
                }
            }
        }
    );
    source.tag("tree", root);
}

/**
 * Work on following tags:
 * ```
 * &lt;script src="foo.js">&lt;/script>
 * &lt;script>Hello world!&lt;/script>
 * &lt;link href="mystyle.css" rel="stylesheet" type="text/css" />
 * &lt;style>body {background: orange;}&lt;/style>
 * ```
 */
function lookForStaticJavascriptAndStyle(root, source) {
    function clear(node) {
        node.type = Tree.VOID;
        delete node.attribs;
        delete node.children;
    }
    var innerJS = "";
    var innerCSS = "";
    var outerJS = [];
    var outerCSS = [];
    source.tag("outerJS", outerJS);
    source.tag("outerCSS", outerCSS);
    Tree.walk(
        root,
        null,
        function(node) {
            if (node.type !== Tree.TAG) return;
            var src;
            switch (node.name) {
                case "script":
                    src = Tree.att(node, "src");
                    if (typeof src === 'string' &amp;&amp; src.length > 0) {
                        outerJS.push(src);
                    } else {
                        innerJS += Tree.text(root);
                    }
                    clear(root);
                    break;
                case "style":
                    innerCSS += Tree.text(root);
                    clear(root);
                    break;
                case "link":
                    if (Tree.att("rel").toLowerCase() == "stylesheet") {
                        src = Tree.att("href").trim();
                        if (typeof src === 'string' &amp;&amp; src.length > 0) {
                            outerCSS.push(src);
                        }
                    }
                    break;
            }
        }
    );
    source.tag("innerJS", "");
    source.tag("innerCSS", "");
}

/**
 * All elements  with the namespace `w:`  are widgets. If the  HTML file
 * contains, for instance,  the widgets `&lt;w:foo>` and  `&lt;w:bar>`, we put
 * `["wdg/foo/compile-foo.js",  "wdg/bar/compile-bar.js"]` into  the tag
 * __`dependencies`__.
 *
 * Then we eventually add the content of `root.extra.css` to the tag __`innerCSS`__.
 */
function expandWidgets(root, source) {
    var prj = source.prj();
    var availableWidgets = prj.getAvailableWidgetCompilers();
    Tree.walk(
        root,
        null,
        // Top-down.
        function (node, parent) {
            if (node.type === Tree.TAG) {
                if (node.name.substr(0, 2) == 'w:') {
                    var widgetName = node.name.substr(2).toLowerCase();
                    var widget = availableWidgets[widgetName];
                    if (!widget) {
                        prj.fatal(
                            "Unknown widget: \"" + widgetName + "\"!",
                            prj.ERR_WIDGET_NOT_FOUND
                        );
                    }
                    precompileWidget(node, source, widget);
                }
            }
        }
    );

    Tree.normalizeChildren(root, true);
    expandDoubleCurlies(root, source);

    Tree.walk(
        root,
        // Bottom-up.
        function (node, parent) {
            if (node.type === Tree.TAG) {
                if (node.name.substr(0, 2) == 'w:') {
                    var widgetName = node.name.substr(2).toLowerCase();
                    var widget = availableWidgets[widgetName];
                    if (!widget) {
                        prj.fatal(
                            "Unknown widget: \"" + widgetName + "\"!",
                            prj.ERR_WIDGET_NOT_FOUND
                        );
                    }
                    compileWidget(node, source, widget);
                }
            }
        }
    );
}

/**
 * Compile the widget.
 */
function precompileWidget(root, source, widget) {
    genericCompileWidget(root, source, widget, "precompile");
    return;
}

/**
 * Compile the widget.
 */
function compileWidget(root, source, widget) {
    genericCompileWidget(root, source, widget, "compile");
}

function genericCompileWidget(root, source, widget, functionName) {
    if (typeof root.name !== 'string') return;
    if (root.name.substr(0, 2) != "w:") return;
    var prj = source.prj();
    var dependencies = source.tag("dependencies");
    var resources = source.tag("resources");
    var outerJS = source.tag("outerJS");
    var innerCSS = source.tag("innerCSS");
    var innerMapCSS = source.tag("innerMapCSS") || {};
    if (functionName === 'compile') {
        // We change the tag name only on Bottom-Up traversal.
        root.name = "div";
    }
    Tree.addClass(root, "custom wtag-" + widget.name);
    root.extra = {dependencies: [], resources: []};
    var id = Tree.att(root, "id") || Tree.nextId();
    Tree.att(root, "id", id);
    root.extra.init = {id: id};
    var controller = "wtag." + widget.name.substr(0, 1).toUpperCase()
        + widget.name.substr(1).toLowerCase();
    if (prj.srcOrLibPath("cls/" + controller + ".js")) {
        root.extra.controller = controller;
        outerJS.push("cls/" + controller + ".js");
    }
    // Looking for extra CSS.
    FS.readdirSync(widget.path).forEach(
        function(filename) {
            if (Path.extname(filename) !== '.css') return;
            if (filename.substr(0, widget.name.length + 1) !== widget.name + "-") return;
            var file = Path.resolve(Path.join(widget.path, filename));
            if (file in innerMapCSS) return;
            innerMapCSS[file] = 1;
            var content = FS.readFileSync(file).toString();
            console.log("inner CSS: " + filename.yellow);
            innerCSS += Util.lessCSS(file, content, false);
            dependencies.push("wdg/" + widget.name + "/" + filename);
        }
    );
    // Compilation.
    var compiler = widget.compiler;
    if (compiler &amp;&amp; typeof compiler[functionName] === 'function') {
        // There is a transformer: we will call it.
        try {
            compiler[functionName].call(prj, root);
            dependencies.push("wdg/" + widget.name + "/compile-" + widget.name + ".js");
            root.extra.resources.forEach(
                function(itm) {
                    resources.push(itm);
                }
            );
            root.extra.dependencies.forEach(
                function(itm) {
                    dependencies.push(itm);
                }
            );
            if (typeof root.extra.innerCSS === 'string') {
                innerCSS += root.extra.innerCSS;
            }
        }
        catch (ex) {
            if (ex.fatal) {
                throw ex;
            } else {
                prj.fatal(
                    "" + ex,
                    prj.ERR_WIDGET_TRANSFORMER,
                    widget.path
                );
            }
        }
    }
    source.tag("innerCSS", innerCSS);
    source.tag("innerMapCSS", innerMapCSS);

    if (functionName == 'compile') {
        // For Bottom-Up traversal, we have to check if another pass is needed or not.
        var deepness = 64;
        var nextNodeToCompile;
        var currentWidgetName;
        var currentWidget;
        var availableWidgets = prj.getAvailableWidgetCompilers();
        while (null != (nextNodeToCompile = needsWidgetCompilation(root))) {
            expandWidgets(nextNodeToCompile, source);
            deepness--;
            if (deepness &lt; 1) {
                prj.fatal(
                    "Too much recursions for widget \"" + widget.name + "\"!",
                    prj.ERR_WIDGET_TOO_DEEP,
                    widget.path
                );
            }
        }
    }
}

/**
 * @return the first node with the namespace `w:`, or null.
 */
function needsWidgetCompilation(root) {
    if (root.type == Tree.TAG &amp;&amp; root.name &amp;&amp; root.name.substr(0, 2) == 'w:') {
        return root;
    }
    if (!root.children) return null;
    var i, node, result;
    for (i = 0 ; i &lt; root.children.length ; i++) {
        node = root.children[i];
        result = needsWidgetCompilation(node);
        if (result) return result;
    }
    return null;
}

/**
 * Initialize controllers by adding script in the __`innerJS`__ tag.
 */
function initControllers(root, source) {
    var innerJS = source.tag("innerJS")
        + "\nwindow.addEventListener(\n"
        + "    'DOMContentLoaded',\n"
        + "    function() {\n"
        + "        document.body.parentNode.$data = {};\n"
        + "        // Attach controllers.\n";
    var extraCSS = "";
    Tree.walk(
        root,
        function(node) {
            var item = node.extra;
            if (!item) return;
            if (item.controller) {
                var ctrlFilename = "cls/" + item.controller + ".js";
                innerJS += "        $$('" + item.controller + "'";
                if (typeof item.init === 'object') {
                    var sep = ', {', key, val;
                    for (key in item.init) {
                        val = item.init[key];
                        if (typeof val === 'string' &amp;&amp; val.substr(0, 9) == 'function(') {
                            // This is a function: we don't want to stringify it.
                        } else {
                            val = JSON.stringify(val);
                        }
                        innerJS += sep;
                        sep = ', ';
                        innerJS += key + ": " + val;
                    }
                    innerJS += "}";

                }
                innerJS += ");\n";
            }
            if (item.css) {
                extraCSS += item.css;
            }
        }
    );

    innerJS += "    }\n);\n";
    source.tag("innerJS", innerJS);
}

/**
 * If the text contains a inner binding syntax, expand it.
 * ```
 * &lt;p>Hello {{name}}!&lt;/p>
 * ```
 * will become
 * ```
 * &lt;p>Hello &lt;w:bind>name&lt;/w:bind>!&lt;/p>
 * ```
 * @param {object} node node of type `Tree.TEXT`.
 */
function expandDoubleCurliesInTextNode(node) {
    var doubleCurliesReplacer = function(txt) {
        return "&lt;w:bind>" + txt.trim() + "&lt;/w:bind>";
    };
    var result = Template.text(node.text, doubleCurliesReplacer);
    if (result.count > 0) {
        node.type = Tree.VOID;
        node.children = [Tree.parse(result.out)];
    }
}

/**
 * Look for all TEXT nodes and eventually replace double curlies.
 */
function expandDoubleCurlies(root, source) {
    Tree.walk(
        root,
        null,
        // Top-Down walk for databindings.
        function(node)  {
            if (node.type !== Tree.TEXT) return;
            if (typeof node.text !== 'string') return;
            var text = node.text;
            if (text.trim().length == 0) return;
            expandDoubleCurliesInTextNode(node);
        }
    );
}

/**
 * Write tags __`zipJS`__ and __`zipCSS`__.
 */
function zipInnerScriptsAndStyles(root, source) {
    source.tag("zipJS", Util.zipJS(source.tag("innerJS")));
    source.tag("outerJS", Util.removeDoubles(source.tag("outerJS")));
    source.tag("outerCSS", Util.removeDoubles(source.tag("outerCSS")));
}

/**
 * Compile dependant JS scripts in cascade.
 */
function compileDependantScripts(root, source) {
    var needed = {};
    var jobs = [];
    var prj = source.prj();
    var file;
    source.tag("outerJS").forEach(
        function(file) {
            jobs.push(file);
        }
    );
    while (jobs.length > 0) {
        file = jobs.pop();
        if (file in needed) continue;
        var srcJS = source.create(file);
        try {
            CompilerJS.compile(srcJS);
            needed[file] = srcJS;
            srcJS.tag("needs").forEach(
                function(item) {
                    jobs.push(item);
                }
            );
        }
        catch (ex) {
            if (ex.fatal) {
                throw ex;
            } else {
                throw ex;

                prj.fatal(ex, -1, file);
            }
        }
    }

    // Save __`linkJS`__ tag.
    var linkJS = [], key;
    for (key in needed) {
        linkJS.push(key);
    }
    source.tag("linkJS", Util.removeDoubles(linkJS));
}

/**
 * Compile dependant CSS styles in cascade.
 */
function compileDependantStyles(root, source) {
    var needed = {};
    var jobs = [];
    var prj = source.prj();
    var file;
    // Add CSS from JS classes.
    source.tag("linkJS").forEach(
        function(item) {
            var srcJS = source.create(item);
            var css = srcJS.tag("css");
            if (css) {
                jobs.push(css);
            }
        }
    );
    // Add
    source.tag("outerCSS").forEach(
        function(file) {
            jobs.push(file);
        }
    );
    while (jobs.length > 0) {
        file = jobs.pop();
        if (file in needed) continue;
        var srcCSS = source.create(file);
        try {
            CompilerCSS.compile(srcCSS);
            needed[file] = srcCSS;
        }
        catch (ex) {
            prj.fatal(ex, -1, file);
        }
    }

    // Save __`linkCSS`__ tag.
    var linkCSS = [], key;
    for (key in needed) {
        linkCSS.push(key);
    }
    source.tag("linkCSS", Util.removeDoubles(linkCSS));
}
</pre>
	</article>
</section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a>
		on 2014-10-11T22:29:13+02:00 using the <a
			href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<!--<script src="scripts/sunlight.js"></script>-->
	<script src="scripts/docstrap.lib.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>

	<script>
		$( function () {
			$( "[id*='$']" ).each( function () {
				var $this = $( this );

				$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
			} );

			$( "#toc" ).toc( {
				anchorName  : function ( i, heading, prefix ) {
					return $( heading ).attr( "id" ) || ( prefix + i );
				},
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : "100px"
			} );

			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );
			$( '.dropdown-toggle' ).dropdown();
//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

			$( ".tutorial-section pre, .readme-section pre" ).each( function () {
				var $this = $( this );

				var example = $this.find( "code" );
				exampleText = example.html();
				var lang = /{@lang (.*?)}/.exec( exampleText );
				if ( lang && lang[1] ) {
					exampleText = exampleText.replace( lang[0], "" );
					example.html( exampleText );
					lang = lang[1];
				} else {
					lang = "javascript";
				}

				if ( lang ) {

					$this
						.addClass( "sunlight-highlight-" + lang )
						.addClass( "linenums" )
						.html( example.html() );

				}
			} );

			Sunlight.highlightAll( {
				lineNumbers : true,
				showMenu : true,
				enableDoclinks : true
			} );
		} );
	 </script>



	<!--Navigation and Symbol Display-->
	
	<script>
		$( function () {
			$( '#main' ).localScroll( {
				offset : { top : 60 } //offset by the height of your header (give or take a few px, see what works for you)
			} );
			$( "dt.name" ).each( function () {
				var $this = $( this ).find("h4");
				var icon = $( "<i/>" ).addClass( "icon-plus-sign" ).addClass( "pull-right" ).addClass( "icon-white" );
				var dt = $(this);
				var children = dt.next( "dd" );

				dt.prepend( icon ).css( {cursor : "pointer"} );
				dt.addClass( "member-collapsed" ).addClass( "member" );


				children.hide();

				dt.children().on( "click", function () {
					children = dt.next( "dd" );
					console.debug(dt, children)
					children.slideToggle( "fast", function () {

						if ( children.is( ":visible" ) ) {
							icon.addClass( "icon-minus-sign" ).removeClass( "icon-plus-sign" ).removeClass( "icon-white" );
							dt.addClass( "member-open" ).animate( "member-collapsed" );
						} else {
							icon.addClass( "icon-plus-sign" ).removeClass( "icon-minus-sign" ).addClass( "icon-white" );
							dt.addClass( "member-collapsed" ).removeClass( "member-open" );
						}
					} );
				} );

			} );
		} );
	</script>
	


	<!--Google Analytics-->
	

</body>
</html>
