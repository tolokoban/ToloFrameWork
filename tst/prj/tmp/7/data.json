{"needs":[],"includes":[],"timestamp":0,"tags":{"def":{"needs":[],"functions":{"user":{"comment":"*\n         * Retourner l'utilisateur actuellement connecté ou null.\n         * {\n         *   id: identifiant unique de l'utilisateur\n         *   login : ...\n         *   name : nom usuel\n         *   enabled : actif ou non\n         *   creation : date de création.\n         *   data : {}\n         * }\n         ","args":[]},"error":{"comment":"*\n         * Retourner la dernière erreur de connexion.\n         * Par exemple, -5 signifie que le mot de passe est erroné.\n         ","args":[]},"login":{"comment":"*\n\t * Accessor for login.\n\t ","args":["v"]},"password":{"comment":"*\n\t * Accessor for password.\n\t ","args":["v"]},"autologin":{"comment":"*\n         * Tente de se  connecter en allant chercher  le dernier login\n         * ayant réussi dans le local storage.\n         ","args":[]},"enc":{"comment":"*\n         * Encoder une chaîen de caractères selon les attributs key et root.\n         ","args":["login","password"]},"dec":{"comment":"*\n         * Décoder le couple login/password.\n         ","args":["arr"]},"connect":{"comment":"*\n\t * Tente une connection. Le retour est asynchrone et se fait\n\t * à travers l'événement Change.\n\t ","args":["login","password"]},"disconnect":{"comment":"*\n         * Déconnecte l'uilisateur courant.\n         ","args":[]},"isLogged":{"comment":"*\n\t * @return True s'il y a un utilisateur actuellement connecté.\n\t ","args":[]},"getData":{"comment":"*\n         * @return data\n         ","args":["key"]},"setData":{"comment":"*\n         * @param data\n         ","args":["key","val"]},"getRoles":{"comment":"","args":[]},"hasRole":{"comment":"","args":["role"]},"send":{"comment":"*\n         * Mettre sur la pile d'envoi la prochaine requête.\n         * Si elle est seule, elle s'exécute immédiatement.\n         ","args":["service","args","success","failure"]},"_next":{"comment":"*\n         * Envoyer au serveur la prochaine requête disponible.\n         * Etats possibles des messages :\n         *  0 : standard.\n         *  1 : standard ayant déjà reçu un refus du serveur pour rôle\n         *  manquant.\n         *  2 : requête de connexion.\n         ","args":["removeLastMsg"]},"_send":{"comment":"*\n         * Appeler un service de façon asynchrone.\n         ","args":["options"]},"_failure":{"comment":"*\n         * Appeler le slot \"failure\" d'un message.\n         ","args":["msg"]},"_success":{"comment":"*\n         * Appeler le slot \"success\" d'un message.\n         ","args":["msg"]},"_onXhrOK":{"comment":"*\n         * Callback pour AJAX quand ça fonctionne.\n         ","args":["xhr"]},"_onXhrKO":{"comment":"*\n         * Callback pour AJAX en cas d'échec.\n         ","args":["xhr"]},"_onResponse":{"comment":"*\n         * @private\n         ","args":["user"]},"_hash":{"comment":"*\n         * @private\n         ","args":["password","code"]}},"comment":"*\n * Cet  objet  devrait  être  instancié   une  seule  fois  dans  vote\n * application et stoqué dans la variable $$.App, par exemple.\n * @code\n * $$.App.login = $$(\"tfw.Server\");\n * @code\n *\n * Pour se connecter, il faut utiliser la méthode connect().\n * @code\n * var login = $$(\"tfw.Server\");\n * login.login( \"tutu\" );\n * login.password( \"phsswdrd\" );\n * login.connect();\n * @code\n *\n * @signal  Change(this)  Se  déclenche  dés  que  l'identification  a\n * changé. Ca peut être un login ou un logout.\n *\n * Etats possibles des messages :\n *  0 : standard.\n *  1  : standard  ayant  déjà  reçu un  refus  du  serveur pour  rôle\n *  manquant.\n *  2 : requête de connexion.\n ","name":"tfw.Server","init":""},"zip":"window[\"TFW::tfw.Server\"]={signals:[\"Login\",\"Logout\",\"LoginFailure\"],attributes:{root:\"tfw/\",autologin:0,login:null,password:null,id:\"tfw\",key:\"ç87&e_rb472.;156er86(%WSRERs\"},init:function(){this.INVALID_JSON=1,this.NOT_GRANTED=2,this._user=null,this._error=0,this._stack=[]},functions:{user:function(){return this._user},error:function(){return this._error},login:function(t){return void 0===t?this._login:(this._login=t,this)},password:function(t){return void 0===t?this._password:(this._password=t,this)},autologin:function(){this._autologin=1;var t=this.dec($$.localLoad(this._id+\".nigolotua\"));return t||(t=[\"\",\"\"]),\"\"==t[0]?!1:(this.login(t[0]),this.password(t[1]),this.connect(),!0)},enc:function(t,e){var s,r,n,o,i=(plain.length,this._key),u=i.length,h=this._root,a=h.length,c=0,l=[];for(s=0;s<t.length;s++)r=t.charCodeAt(s),n=i.charCodeAt(c&u),o=h.charCodeAt(c&a),c++,l.push(r^n^o);for(n=i.charCodeAt(c&u),o=h.charCodeAt(c&a),c++,l.push(n^o),s=0;s<t.length;s++)r=e.charCodeAt(s),n=i.charCodeAt(c&u),o=h.charCodeAt(c&a),c++,l.push(r^n^o);return l},dec:function(t){var e,s,r,n,o=t.length,i=this._key,u=i.length,h=this._root,a=h.length,c=0,l=\"\",_=\"\";for(e=0;o>e&&(s=t[e],r=i.charCodeAt(c&u),n=h.charCodeAt(c&a),c++,s^=r^n,0!=s);e++)l+=String.fromCharCode(s);for(;o>e&&(s=t[e],r=i.charCodeAt(c&u),n=h.charCodeAt(c&a),c++,s^=r^n,0!=s);e++)_+=String.fromCharCode(s);return[l,_]},connect:function(t,e){var s=this;return void 0!==t&&s.login(t),void 0!==e&&s.password(e),s._error=0,s._stack.splice(0,0,{service:\"tfw.login.Challenge\",args:this.login(),success:function(t){s._stack.splice(1,0,{service:\"tfw.login.Response\",args:s._hash(s._password,t.out),success:function(t){s._onResponse(t.out)},failure:function(t){console.error(\"challenge failed: \",t)},status:2})},failure:function(t){console.error(\"challenge failed: \",t)},status:2}),s._next(),s},disconnect:function(){var t=this;return t.send(\"tfw.login.Logout\",null,function(){t.fireLogout()}),t._roles=[],t._data={},t._user=null,$$.localSave(t._id+\".nigolotua\",null),t},isLogged:function(){return this._user&&this._user.roles.length>0?!0:!1},getData:function(t){return this._user&&this._user.data?this._user.data[t]:void 0},setData:function(t,e){return this._user?(this._user.data||(this._user.data={}),this._user.data[t]=e,void $$.service(\"tfw.login.SetData\",{k:t,v:e})):void 0},getRoles:function(){return this._roles},hasRole:function(t){if(!this._user)return!1;if(!this._user.roles)return!1;for(var e in this._user.roles)if(t.toUpperCase()==this._user.roles[e].toUpperCase())return!0;return!1},send:function(t,e,s,r){this._stack.push({service:t,args:e,success:s,failure:r,status:0,sent:0}),this._next()},_next:function(t){if(!(this._stack.length<1||t&&(this._stack.splice(0,1),this._stack.length<1))){var e,s;for(console.log(\"----------------------------------------\"),e=0;e<this._stack.length;e++)s=this._stack[e],console.log(s.service,s.sent);var r=this,n=this._stack[0];n.sent||(n.sent=1,r._send(n))}},_send:function(t){var e=this,s=e._xhr,r=\"\";s||(e._xhr=new XMLHttpRequest({mozSystem:!0}),s=e._xhr,s.onload=function(){e._onXhrOK(s)},s.onerror=function(){e._onXhrOK(s)}),s.open(\"POST\",this._root+\"svc.php\",!0),r=\"s=\"+encodeURIComponent(t.service)+\"&i=\"+encodeURIComponent(JSON.stringify(t.args)),s.setRequestHeader(\"Content-type\",\"application/x-www-form-urlencoded\"),s.withCredentials=!0,s.send(r)},_failure:function(t){try{t.failure?t.failure(t):console.error(\"[tfw.Server] No failure slot!\",t)}catch(e){console.error(\"[tfw.Server] Exception in failure's slot!\",t,e)}},_success:function(t){try{t.success&&t.success(t)}catch(e){console.error(\"[tfw.Server] Exception in success's slot!\",t,e)}},_onXhrOK:function(t){var e,s=this,r=t.responseText,n=!1,o=this._stack[0];try{e=JSON.parse(r),o.out=e}catch(i){return o.err=this.INVALID_JSON,o.msg=r,s._failure(o),void s._next(1)}return console.info(\"[tfw.Server] data=...\",e),\"string\"==typeof e&&\"<<<\"==e.substr(0,3)&&(n=!0),0==o.status?n?(o.status=1,delete o.sent,void s.connect()):(s._success(o),void s._next(1)):1==o.status&&n?(o.err=s.NOT_GRANTED,o.msg=e,s._failure(o),void s._next(1)):(s._success(o),void s._next(1))},_onXhrKO:function(t){console.error(\"[tfw.Server] (KO) xhr=...\",t);var e=this._stack[0];self._failure(e),self._next(1)},_onResponse:function(t){return\"object\"==typeof t?(this._user=t,this._error=0,this._autologin&&$$.localSave(this._id+\".nigolotua\",this.enc(this.login(),this.password())),this.fireLogin(this),!0):(this._user=null,this._error=t,this.fireLoginFailure(this),!1)},_hash:function(t,e){var s,r,n,o,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],u=0,h=[];for(s=0;s<t.length;s++)h.push(t.charCodeAt(s));for(256%h.length==0&&h.push(0),s=0;256>s;s++)i[s%16]^=s+h[s%h.length],r=e[u++%e.length]%16,n=e[u++%e.length]%16,o=e[u++%e.length]%16,i[o]^=(i[o]+16*n+o)%256,i[n]^=(i[r]+i[o])%256;return i}}};"}}